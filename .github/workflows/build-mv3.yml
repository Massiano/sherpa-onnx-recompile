name: Build MV3 WASM

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # We create the script on the fly to avoid committing it if you prefer
      - name: Create Build Script
        run: |
          cat << 'EOF' > build-mv3.sh
          #!/bin/bash
          set -e
          mkdir -p build-mv3 dist-mv3 && cd build-mv3
          export SHERPA_ONNX_IS_USING_BUILD_WASM_SH=ON
          export LDFLAGS="-s DYNAMIC_EXECUTION=0 -msimd128 -s TEXTDECODER=2 -s MODULARIZE=1 -s EXPORT_ES6=1 -s EXPORT_NAME='SherpaOnnx' -s ENVIRONMENT='web,worker' -s ALLOW_MEMORY_GROWTH=1 -s MAXIMUM_MEMORY=4GB -s WASM=1 -s SINGLE_FILE=0 -O3"
          emcmake cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DSHERPA_ONNX_ENABLE_PYTHON=OFF -DSHERPA_ONNX_ENABLE_TESTS=OFF -DSHERPA_ONNX_ENABLE_C_API=ON -DSHERPA_ONNX_ENABLE_WASM_ASR=ON -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" ..
          emmake make -j$(nproc)
          cp bin/wasm/asr/sherpa-onnx-wasm-asr.js ../dist-mv3/
          cp bin/wasm/asr/sherpa-onnx-wasm-asr.wasm ../dist-mv3/
          EOF
          chmod +x build-mv3.sh

      - name: Run Build in Docker
        uses: addnab/docker-run-action@v3
        with:
          image: emscripten/emsdk:3.1.53
          options: -v ${{ github.workspace }}:/app
          run: /app/build-mv3.sh

      - uses: actions/upload-artifact@v4
        with:
          name: sherpa-mv3-wasm
          path: dist-mv3/
